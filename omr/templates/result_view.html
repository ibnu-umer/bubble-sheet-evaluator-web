{% extends 'base.html' %}
{% load static %}
{% block title %}Evaluated Results{% endblock %}

{% block content %}
<div class="page-section">
    <h2 class="section-title">Evaluation Results</h2>
    <!-- Header Section -->
    <header class="result-header">
        <h2 class="exam-name">{{ exam.exam_name.upper }}</h2>
        <h3 class="org-name">{{ exam.org_name.upper }}</h3>
        <div class="results-meta">
            <span class="meta-item"><strong>Date:</strong> {{ exam.exam_date|date:"d M Y" }}</span>
            <span class="meta-item">
                <strong>Pass Mark:</strong> {{ exam.pass_mark }}
            </span>
        </div>
    </header>

    <!-- Results Table -->
    <section class="results-section">
        <table class="results-table" id="result-table">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.roll_no }}</td>
                    <td>{{ row.score|floatformat:0 }}</td>
                    <td class="{% if row.score >= exam.pass_mark %}status-pass{% else %}status-fail{% endif %}">
                        {% if row.score >= exam.pass_mark %} Pass {% else %} Fail {% endif %}
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>

        <!-- Download Buttons -->
        <div class="download-buttons">
            <button id="download-csv-btn" class="button">Download CSV</button>
            <button id="download-xlsx-btn" class="button">Download Excel</button>
            <button id="download-pdf-btn" class="button">Download Sheet PDF</button>
        </div>
    </section>




    <!-- Error Section -->
    {% if errors %}
        <section class="error-section">
            <h3 class="section-subtitle">Errored Files</h3>
            <form id="csrf-form">{% csrf_token %}</form>
            <table class="error-table">
                <thead>
                    <tr>
                        <th>Preview</th>
                        <th>Roll No</th>
                        <th>Score</th>
                        <th>Submit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for err in errors %}
                    <tr>
                        <td class="table-actions">
                            <button
                                class="preview-btn"
                                type="button"
                                data-img="{{ err.sheet.url }}"
                            >
                            View Image
                            </button>
                        </td>
                        <td>
                            <input
                                type="number"
                                name="roll_no"
                                class="rollno-input"
                                min="0"
                                max="999999"
                                required
                            />
                        </td>
                        <td>
                            <input
                                type="number"
                                name="score"
                                class="score-input"
                                min="0"
                                max="100"
                                required
                            />
                        </td>
                        <td>
                            <button type="button" class="btn btn-submit submit-btn">Submit</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    {% endif %}
</div>

<!-- Preview Overlay for Sheet -->
<div class="preview-overlay" id="sheetOverlay">
    <span class="close-btn" id="closeSheetPreview">&times;</span>
    <img id="sheetPreviewImage" src="" alt="Sheet Preview" />
</div>

{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/result_view.css' %}">
<link rel="stylesheet" href="{% static 'css/results_page.css' %}">
{% endblock %}

{% block scripts %}
<script src="{% static 'js/result_view.js' %}"></script>
{% endblock %}
