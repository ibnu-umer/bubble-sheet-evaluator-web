<!DOCTYPE html>
<html>
<head>
    <title>Evaluation Results</title>
    <style>
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 5px;
        }
    </style>
</head>
    <body>
        <h2>Evaluation Results</h2>
        <h2>{{ exam.exam_name }}</h2>
        <h3>{{ exam.org_name }}</h3>
        <div>{{ exam.exam_date }}</div>
        <table border="1" id="result-table">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.roll_no }}</td>
                    <td>{{ row.score }}</td>
                    <td>
                        {% if row.score >= exam.pass_mark %}
                            Pass
                        {% else %}
                            Fail
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button id="download-csv-btn">Download CSV</button>
        <button id="download-xlsx-btn">Download Excel</button>

        <button id="download-pdf-btn">Download Sheet PDF</button>
        <div id="progress-container">
            <div id="progress-bar">0%</div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script>
            const examName = "{{ exam.exam_name|escapejs }}"
            const examNameLower = examName.toLowerCase().replace(/\s+/g, "_");

            document.getElementById("download-pdf-btn").addEventListener("click", async function(event) {
                event.preventDefault();
                let btn = this;
                btn.textContent = "Downloading...";
                btn.disabled = true;

                try {
                    const response = await fetch("{% url 'download_sheet_pdf' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ examName: examName }),
                    });

                    if (!response.ok) throw new Error("Failed to generate PDF");

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${examName}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();

                    window.URL.revokeObjectURL(url);
                } catch (err) {
                    console.error("Error:", err);
                    alert("Failed to download PDF. Please try again.");
                }

                setTimeout(() => {
                    btn.textContent = "Download Sheet PDF";
                    btn.disabled = false;
                }, 3000);
            });


            // Function to export table to CSV
            function downloadTableCSV(filename) {
                let btn = document.getElementById("download-csv-btn");
                btn.textContent = "Downloading...";
                btn.disabled = true;

                let csv = [];
                let rows = document.querySelectorAll("#result-table tr");

                for (let row of rows) {
                    let cols = row.querySelectorAll("td, th");
                    let rowData = [];
                    for (let col of cols) {
                        rowData.push(col.innerText);
                    }
                    csv.push(rowData.join(","));
                }

                let csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
                let downloadLink = document.createElement("a");
                downloadLink.download = filename;
                downloadLink.href = URL.createObjectURL(csvFile);
                downloadLink.click();

                setTimeout(() => {
                    btn.textContent = "Download CSV";
                    btn.disabled = false;
                }, 2000);
            }


            // Function to export table to Excel
            function downloadTableExcel(filename) {
                let btn = document.getElementById("download-xlsx-btn");
                btn.textContent = "Downloading...";
                btn.disabled = true;

                let table = document.getElementById("result-table");
                let wb = XLSX.utils.table_to_book(table, { sheet: "Results" });
                XLSX.writeFile(wb, filename, { bookType: "xlsx", type: "binary" });

                setTimeout(() => {
                    btn.textContent = "Download Excel";
                    btn.disabled = false;
                }, 2000);
            }


            // Event Listeners
            document.getElementById("download-csv-btn").addEventListener("click", function () {
                downloadTableCSV(examNameLower + ".csv");
            });

            document.getElementById("download-xlsx-btn").addEventListener("click", function () {
                downloadTableExcel(examNameLower + ".xlsx");
            });
        </script>
    </body>
</html>
