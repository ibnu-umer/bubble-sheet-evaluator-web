<!DOCTYPE html>
<html>
<head>
    <title>Evaluation Results</title>
    <style>
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 5px;
        }
    </style>
</head>
    <body>
        <h2>Evaluation Results</h2>
        <h2>{{ examName }}</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.roll }}</td>
                    <td>{{ row.score }}</td>
                    <td>{{ row.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button id="convert-pdf-btn">Convert Images to PDF</button>
        <div id="progress-container">
        <div id="progress-bar">0%</div>
        </div>

        <script>
            document.getElementById("convert-pdf-btn").addEventListener(
                "click",
                async function(event) {
                    event.preventDefault();

                    const examName = "{{ examName|escapejs }}"

                    const progressContainer = document.getElementById("progress-container");
                    const progressBar = document.getElementById("progress-bar");

                    // Reset & show progress bar
                    if (progressContainer && progressBar) {
                        progressContainer.style.display = "block";
                        progressBar.style.width = "0%";
                        progressBar.innerText = "0%";
                    }

                    try {
                        const response = await fetch("{% url 'convert_to_pdf' %}", {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}",
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ examName: examName }),
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = "";

                        function handleData(data) {
                            console.log("handleData called with:", data);

                            // Update progress
                            if (data.progress !== undefined && progressBar) {
                                progressBar.style.width = data.progress + "%";
                                progressBar.innerText = data.progress + "%";
                            }

                            // Handle result URL
                            if (data.pdf_url) {
                                const resultsDiv = document.getElementById("results");
                                if (resultsDiv) {
                                    resultsDiv.style.display = "block";
                                    resultsDiv.innerHTML = `
                                        <p>PDF created successfully!</p>
                                        <a href="${data.pdf_url}" target="_blank" class="btn btn-primary">
                                            Download PDF
                                        </a>
                                    `;
                                }
                            }
                        }

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });

                            let parts = buffer.split("\n");
                            buffer = parts.pop();

                            for (let part of parts) {
                                if (!part.trim()) continue;
                                try {
                                    const data = JSON.parse(part);
                                    handleData(data);
                                } catch (e) {
                                    console.error("Failed to parse chunk:", part, e);
                                }
                            }
                        }

                        // Process leftover
                        if (buffer.trim()) {
                            try {
                                const data = JSON.parse(buffer);
                                handleData(data);
                            } catch (e) {
                                console.error("Failed to parse leftover:", buffer, e);
                            }
                        }
                    } catch (err) {
                        console.error("Error:", err);
                        if (progressContainer) progressContainer.style.display = "none";
                        alert("Failed to convert PDF. Please try again.");
                    }
                }
            );
        </script>
    </body>
</html>
