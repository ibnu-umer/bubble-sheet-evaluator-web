<!DOCTYPE html>
<html>
<head>
    <title>Evaluation Results</title>
    <style>
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 5px;
        }
        .overlay {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            }

            .overlay:target {
            display: flex;
            }

            .overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            }

            .close-btn {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 40px;
            color: white;
            text-decoration: none;
            }
    </style>
</head>
    <body>
        <h2>Evaluation Results</h2>
        <h2>{{ exam.exam_name }}</h2>
        <h3>{{ exam.org_name }}</h3>
        <div>{{ exam.exam_date }}</div>
        <table border="1" id="result-table">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.roll_no }}</td>
                    <td>{{ row.score }}</td>
                    <td>
                        {% if row.score >= exam.pass_mark %}
                            Pass
                        {% else %}
                            Fail
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button id="download-csv-btn">Download CSV</button>
        <button id="download-xlsx-btn">Download Excel</button>

        <button id="download-pdf-btn">Download Sheet PDF</button>
        <div id="progress-container">
            <div id="progress-bar">0%</div>
        </div>


        <h3>Errored Files</h3>
        <form id="csrf-form">{% csrf_token %}</form>
        <table border="1">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Roll No</th>
                    <th>Score</th>
                    <th>Submit</th>
                </tr>
            </thead>
            <tbody>
                {% for err_sheet in errored_sheets %}
                    <tr>
                        <td><a href="#overlay-{{ forloop.counter }}">
                            <button type="button">View Image</button></a>
                        </td>
                        <td><input type="number" name="roll_no" class="rollno-input" min="0" max="999999" required></td>
                        <td><input type="number" name="score" class="score-input" min="0" max="100" required></td>
                        <td><button type="button" class="submit-btn">Submit</button></td>
                    </tr>

                    <!-- Overlay Section -->
                    <div id="overlay-{{ forloop.counter }}" class="overlay">
                        <a href="#" class="close-btn">&times;</a>
                        <img src="{{ err_sheet }}" alt="Image Preview">
                    </div>
                {% endfor %}
            </tbody>
        </table>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script>
            const examName = "{{ exam.exam_name|escapejs }}";
            const examNameLower = examName.toLowerCase().replace(/\s+/g, "_");

            document.getElementById("download-pdf-btn").addEventListener("click", async function(event) {
                event.preventDefault();
                let btn = this;
                btn.textContent = "Downloading...";
                btn.disabled = true;

                try {
                    const response = await fetch("{% url 'download_sheet_pdf' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ examName: examName }),
                    });

                    if (!response.ok) throw new Error("Failed to generate PDF");

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${examName}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();

                    window.URL.revokeObjectURL(url);
                } catch (err) {
                    console.error("Error:", err);
                    alert("Failed to download PDF. Please try again.");
                }

                setTimeout(() => {
                    btn.textContent = "Download Sheet PDF";
                    btn.disabled = false;
                }, 3000);
            });


            // Function to export table to CSV
            function downloadTableCSV(filename) {
                let btn = document.getElementById("download-csv-btn");
                btn.textContent = "Downloading...";
                btn.disabled = true;

                let csv = [];
                let rows = document.querySelectorAll("#result-table tr");

                for (let row of rows) {
                    let cols = row.querySelectorAll("td, th");
                    let rowData = [];
                    for (let col of cols) {
                        rowData.push(col.innerText);
                    }
                    csv.push(rowData.join(","));
                }

                let csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
                let downloadLink = document.createElement("a");
                downloadLink.download = filename;
                downloadLink.href = URL.createObjectURL(csvFile);
                downloadLink.click();

                setTimeout(() => {
                    btn.textContent = "Download CSV";
                    btn.disabled = false;
                }, 2000);
            }


            // Function to export table to Excel
            function downloadTableExcel(filename) {
                let btn = document.getElementById("download-xlsx-btn");
                btn.textContent = "Downloading...";
                btn.disabled = true;

                let table = document.getElementById("result-table");
                let wb = XLSX.utils.table_to_book(table, { sheet: "Results" });
                XLSX.writeFile(wb, filename, { bookType: "xlsx", type: "binary" });

                setTimeout(() => {
                    btn.textContent = "Download Excel";
                    btn.disabled = false;
                }, 2000);
            }


            // Event Listeners
            document.getElementById("download-csv-btn").addEventListener("click", function () {
                downloadTableCSV(examNameLower + ".csv");
            });

            document.getElementById("download-xlsx-btn").addEventListener("click", function () {
                downloadTableExcel(examNameLower + ".xlsx");
            });

            // Submit error table data
            const exam_id = "{{ exam.exam_id|safe }}"
            document.addEventListener("DOMContentLoaded", function() {
                const buttons = document.querySelectorAll(".submit-btn");

                buttons.forEach(btn => {
                    btn.addEventListener("click", function() {
                        const row = btn.closest("tr");
                        const roll_no = row.querySelector(".rollno-input").value;
                        const score = row.querySelector(".score-input").value;

                        if (!roll_no || !score) {
                            alert("Please fill roll number and mark first.");
                            return;
                        }

                        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

                        fetch("{% url 'submit_mark' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                                "X-CSRFToken": csrfToken
                            },
                            body: new URLSearchParams({
                                roll_no: roll_no,
                                score: Number(score),
                                exam_id: exam_id,
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const tableBody = document.querySelector("#result-table tbody");
                                let existingRow = Array.from(tableBody.rows).find(
                                    row => row.cells[0].textContent === roll_no
                                );
                                if (existingRow) {
                                    alert(`Roll No: ${roll_no} already exists`);
                                } else {
                                    updateResultTable(roll_no, score);
                                    btn.textContent = "âœ… Saved";
                                    btn.disabled = true;
                                }
                            }
                        })
                        .catch(err => {
                            alert("Server error: " + err);
                        });
                    });
                });
            });

            const passMark = Number("{{ exam.pass_mark|safe }}");
            function updateResultTable(roll_no, score) {
                const tableBody = document.querySelector("#result-table tbody");
                const newRow = document.createElement("tr");

                newRow.innerHTML = `
                    <td>${roll_no}</td>
                    <td>${score}</td>
                    <td>${score >= passMark ? 'Pass' : 'Fail'}</td>
                `;
                tableBody.appendChild(newRow);
            }
        </script>
    </body>
</html>
