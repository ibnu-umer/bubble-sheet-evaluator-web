<!DOCTYPE html>
<html>
<head>
    <title>Evaluation Results</title>
    <style>
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 5px;
        }
    </style>
</head>
    <body>
        <h2>Evaluation Results</h2>
        <h2>{{ exam.exam_name }}</h2>
        <h3>{{ exam.org_name }}</h3>
        <div>{{ exam.exam_date }}</div>
        <table border="1" id="result-table">
            <thead>
                <tr>
                    <th>Roll</th>
                    <th>Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.roll_no }}</td>
                    <td>{{ row.score }}</td>
                    <td>
                        {% if row.score >= exam.pass_mark %}
                            Pass
                        {% else %}
                            Fail
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button id="convert-result-csv">Convert Result into CSV</button>
        <button id="convert-result-xlsx">Convert Result into Excel</button>

        <button id="convert-pdf-btn">Convert Images to PDF</button>
        <div id="progress-container">
            <div id="progress-bar">0%</div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script>
            const examName = "{{ examName|escapejs }}"
            const examNameLower = examName.toLowerCase().replace(/\s+/g, "_");

            document.getElementById("convert-pdf-btn").addEventListener(
                "click",
                async function(event) {
                    event.preventDefault();

                    const progressContainer = document.getElementById("progress-container");
                    const progressBar = document.getElementById("progress-bar");

                    // Reset & show progress bar
                    if (progressContainer && progressBar) {
                        progressContainer.style.display = "block";
                        progressBar.style.width = "0%";
                        progressBar.innerText = "0%";
                    }

                    try {
                        const response = await fetch("{% url 'convert_to_pdf' %}", {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}",
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ examName: examName }),
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = "";

                        function handleData(data) {
                            console.log("handleData called with:", data);

                            // Update progress
                            if (data.progress !== undefined && progressBar) {
                                progressBar.style.width = data.progress + "%";
                                progressBar.innerText = data.progress + "%";
                            }

                            // Handle result URL
                            if (data.pdf_url) {
                                const resultsDiv = document.getElementById("results");
                                if (resultsDiv) {
                                    resultsDiv.style.display = "block";
                                    resultsDiv.innerHTML = `
                                        <p>PDF created successfully!</p>
                                        <a href="${data.pdf_url}" target="_blank" class="btn btn-primary">
                                            Download PDF
                                        </a>
                                    `;
                                }
                            }
                        }

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });

                            let parts = buffer.split("\n");
                            buffer = parts.pop();

                            for (let part of parts) {
                                if (!part.trim()) continue;
                                try {
                                    const data = JSON.parse(part);
                                    handleData(data);
                                } catch (e) {
                                    console.error("Failed to parse chunk:", part, e);
                                }
                            }
                        }

                        // Process leftover
                        if (buffer.trim()) {
                            try {
                                const data = JSON.parse(buffer);
                                handleData(data);
                            } catch (e) {
                                console.error("Failed to parse leftover:", buffer, e);
                            }
                        }
                    } catch (err) {
                        console.error("Error:", err);
                        if (progressContainer) progressContainer.style.display = "none";
                        alert("Failed to convert PDF. Please try again.");
                    }
                }
            );


            // Function to export table to CSV
            function exportTableToCSV(filename) {
                let csv = [];
                let rows = document.querySelectorAll("#result-table tr");

                for (let row of rows) {
                    let cols = row.querySelectorAll("td, th");
                    let rowData = [];
                    for (let col of cols) {
                        rowData.push(col.innerText);
                    }
                    csv.push(rowData.join(","));
                }

                let csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
                let downloadLink = document.createElement("a");
                downloadLink.download = filename;
                downloadLink.href = URL.createObjectURL(csvFile);
                downloadLink.click();
            }


            // Function to export table to Excel
            function exportTableToExcel(filename) {
                let table = document.getElementById("result-table");
                let wb = XLSX.utils.table_to_book(table, { sheet: "Results" });
                XLSX.writeFile(wb, filename);
            }


            // Event Listeners
            document.getElementById("convert-result-csv").addEventListener("click", function () {
                exportTableToCSV(examNameLower + ".csv");
            });

            document.getElementById("convert-result-xlsx").addEventListener("click", function () {
                exportTableToExcel(examNameLower + ".xlsx");
            });
        </script>
    </body>
</html>
